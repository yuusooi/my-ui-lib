<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script>
        function myNew(fn,...args) {
            if (Object.prototype.toString.call(fn) !== "[object Function]") {
                return "Error in params"
            }
            const obj = Object.create(fn.prototype)
            const ret = fn.call(obj,...args)
            return (typeof ret === 'object' && ret !== null) || typeof ret === 'function'
                ? ret
                : obj
        }

        function myNew(fn, ...args) {
            // æ ¡éªŒä¼ è¿›æ¥çš„æ˜¯ä¸æ˜¯å‡½æ•°
            // newåé¢åªèƒ½è·Ÿæ„é€ å‡½æ•°
            if (Object.prototype.toString.call(fn) !== "[object Function]") {
                return "Error in params"
            }
            // åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡
            // è®©è¿™ä¸ªå¯¹è±¡çš„åŸå‹æŒ‡å‘æ„é€ å‡½æ•°çš„prototype
            // ç›¸å½“äºobj.__proto__ = fn.prototype
            const obj = Object.create(fn.prototype)
            // ç”¨è¿™ä¸ªå¯¹è±¡ä½œä¸ºthisï¼Œæ‰§è¡Œæ„é€ å‡½æ•°
            // fn.call(obj, ...args)ç­‰ä»·äºnew fn(...args)ä¸­çš„æ‰§è¡Œæ„é€ å‡½æ•°
            let ret = fn.call(obj, ...args)
            // å¦‚æœæ„é€ å‡½æ•°è¿”å›å¯¹è±¡ï¼Œå°±ç”¨å®ƒï¼›å¦åˆ™ç”¨åˆšåˆ›å»ºçš„å¯¹è±¡
            return ret instanceof Object ? ret : obj
        }


        // é…åˆä¾‹å­ç†è§£ï¼ˆæœ€å…³é”®ï¼‰
        // ä¾‹å­ 1ï¼šæ™®é€šæ„é€ å‡½æ•°ï¼ˆæœ€å¸¸è§ï¼‰
        // function Person(name) {
        //   this.name = name
        // }

        // const p = myNew(Person, 'Tom')

        // æ‰§è¡Œè¿‡ç¨‹ã€Œäººè„‘æ¨¡æ‹Ÿã€

        // 1ï¸âƒ£ Object.create(Person.prototype)
        // â†’ å¾—åˆ°ä¸€ä¸ªç©ºå¯¹è±¡ {}
        // â†’ ä½†å®ƒèƒ½è®¿é—® Person.prototype ä¸Šçš„æ–¹æ³•

        // 2ï¸âƒ£ fn.call(obj, 'Tom')
        // â†’ ç›¸å½“äºæ‰§è¡Œï¼š

        // obj.name = 'Tom'


        // 3ï¸âƒ£ æ„é€ å‡½æ•°æ²¡ return å¯¹è±¡
        // â†’ è¿”å› obj

        // æœ€ç»ˆï¼š

        // p = { name: 'Tom' }
        // p.__proto__ === Person.prototype // true


        // âœ… å®Œå…¨ç­‰ä»· new Person('Tom')

        // ä¾‹å­ 2ï¼šæ„é€ å‡½æ•° ä¸»åŠ¨ return å¯¹è±¡
        // function Person(name) {
        //   this.name = name
        //   return { age: 18 }
        // }

        // const p = myNew(Person, 'Tom')

        // å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

        // ret æ˜¯ { age: 18 }

        // ret instanceof Object === true

        // new çš„è§„åˆ™ï¼šè¿”å›è¿™ä¸ªå¯¹è±¡

        // æœ€ç»ˆï¼š

        // p === { age: 18 }


        // ğŸ‘‰ this.name = 'Tom' ç›´æ¥è¢«æŠ›å¼ƒ
        // ğŸ‘‰ å’ŒåŸç”Ÿ new è¡Œä¸ºå®Œå…¨ä¸€è‡´

        // ä¾‹å­ 3ï¼šreturn åŸºæœ¬ç±»å‹ï¼ˆæ²¡ç”¨ï¼‰
        // function Person(name) {
        //   this.name = name
        //   return 123
        // }

        // const p = myNew(Person, 'Tom')

        // 123 instanceof Object === false

        // å¿½ç•¥ return

        // è¿”å› obj

        // æœ€ç»ˆï¼š

        // p = { name: 'Tom' }

        // âœ… è¿˜æ˜¯ç¬¦åˆ new çš„è§„åˆ™
    </script>
</body>
</html>